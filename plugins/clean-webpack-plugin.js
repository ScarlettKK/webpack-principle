// ä½œç”¨ï¼šåœ¨ webpack æ‰“åŒ…è¾“å‡ºå‰å°†ä¸Šæ¬¡æ‰“åŒ…å†…å®¹æ¸…ç©ºã€‚

/**
 * å¼€å‘æ€è·¯ï¼š
 * ææ¸…æ¥šä½•æ—¶ã€åœ¨ä»€ä¹ˆæ—¶é—´èŠ‚ç‚¹ä¸Šåšè¿™ä¸ªäº‹æƒ…
 * 
 * åœ¨ä¸€å¼€å§‹å°±æ‰§è¡Œï¼Ÿä¸‡ä¸€æµç¨‹å‡ºé”™é€€å‡ºwebpackï¼Œä¹‹å‰çš„æ‰“åŒ…å†…å®¹å°±å…¨æ²¡äº†âŒ
 * 
 * åœ¨æ‰“åŒ…è¾“å‡ºå‰æ‰§è¡Œï¼Ÿè¿™æ ·ä¸‡ä¸€å‰é¢æœ‰å•¥é”™è¯¯ï¼Œä¹‹å‰æ‰“åŒ…çš„å†…å®¹è¿˜åœ¨ã€‚ç¡®ä¿ä¹‹å‰éƒ½æˆåŠŸå†æ¸…ç©ºğŸ‘
 * 
 * å¦‚ä½•åœ¨æ‰“åŒ…è¾“å‡ºå‰æ‰§è¡Œï¼Ÿ
 * éœ€è¦ä½¿ç”¨ compiler.hooks.emit é’©å­, å®ƒæ˜¯æ‰“åŒ…è¾“å‡ºå‰è§¦å‘ã€‚
 * 
 * å¦‚ä½•æ¸…ç©ºä¸Šæ¬¡æ‰“åŒ…å†…å®¹ï¼Ÿ
 * è·å–æ‰“åŒ…è¾“å‡ºç›®å½•ï¼šé€šè¿‡ compiler å¯¹è±¡ã€‚
 * é€šè¿‡æ–‡ä»¶æ“ä½œæ¸…ç©ºå†…å®¹ï¼šé€šè¿‡ compiler.outputFileSystem æ“ä½œæ–‡ä»¶ã€‚
 */

class CleanWebpackPlugin {
  // è¦åšä»€ä¹ˆï¼Ÿ
  // 1. æ³¨å†Œé’©å­ï¼Œåœ¨æ‰“åŒ…è¾“å‡ºä¹‹å‰ emit
  // 2. è·å–æ‰“åŒ…è¾“å‡ºçš„ç›®å½•ï¼Œä¸èƒ½ç›´æ¥å†™æ­»
  // 3. é€šè¿‡fsåˆ é™¤æ‰“åŒ…è¾“å‡ºç›®å½•ä¸‹æ‰€æœ‰çš„æ–‡ä»¶

  apply(compiler) {
    // emitæ˜¯å¼‚æ­¥ä¸²è¡Œé’©å­ï¼Œã€è®°å¾—æœ€åè°ƒç”¨callbackã€‘
    compiler.hooks.emit.tapAsync("CleanWebpackPlugin", (compilation, callback) => {
      // è·å–è¾“å‡ºæ–‡ä»¶ç›®å½•
      // è¿™ç‚¹åœ¨webpack.config.jsä¸­é…ç½®
      const outputPath = compiler.options.output.path;
      // å¦ä¸€ç§è·å–è·¯å¾„æ–¹å¼ï¼Œç»è¿‡æ‰“å°éªŒè¯ä¸¤ä¸ªå€¼æ˜¯ä¸€æ ·çš„
      // ä¸è¿‡ä¸‹é¢çš„æ–¹æ³•å¯èƒ½ä¸é€‚ç”¨æ‰€æœ‰é…ç½®ï¼ˆæœ‰çš„æ—¶å€™ä¼šæ²¡æœ‰å€¼ï¼‰ï¼Œå¯ä»¥è¿›è¡Œæ‰“å°éªŒè¯
      // const outputPath = compiler.outputPath;  

      // è·å–æ“ä½œæ–‡ä»¶çš„å¯¹è±¡
      const fs = compiler.outputFileSystem;

      // åˆ é™¤ç›®å½•æ‰€æœ‰æ–‡ä»¶
      // ä¼ å…¥fs+è·¯å¾„ï¼Œè·¯å¾„ä¸ºæ–‡ä»¶å¤¹
      // åªåœ¨å¤–å±‚è°ƒç”¨è¿™ä¸€æ¬¡ï¼Œåé¢çš„éƒ½æ˜¯é€’å½’è°ƒç”¨
      const err = this.removeFiles(fs, outputPath);
      // æ‰§è¡ŒæˆåŠŸerrä¸ºundefinedï¼Œæ‰§è¡Œå¤±è´¥errå°±æ˜¯é”™è¯¯åŸå› 
      callback(err);
    });
  }

  // è¿™é‡Œå•ç‹¬å®šä¹‰ä¸€ä¸ªå‡½æ•°æ¥æ‰§è¡Œåˆ é™¤
  // å¦‚ä½•åˆ é™¤ï¼Ÿè¦åˆ é™¤æŸä¸ªç›®å½•ï¼Œéœ€è¦æŠŠè¿™ä¸ªç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶ç»™åˆ äº†ï¼Œæ‰èƒ½åˆ ç›®å½•
  //         å¦‚æœæœ‰ä¸€ä¸ªæ–‡ä»¶æ²¡åˆ ï¼Œç›®å½•å°±åˆ ä¸æ‰
  // æƒ³è¦åˆ é™¤æ‰“åŒ…è¾“å‡ºç›®å½•ä¸‹æ‰€æœ‰èµ„æºï¼Œéœ€è¦å…ˆå°†ç›®å½•ä¸‹çš„èµ„æºåˆ é™¤ï¼Œæ‰èƒ½åˆ é™¤è¿™ä¸ªç›®å½•
  removeFiles(fs, path) {// pathï¼šæ–‡ä»¶å¤¹è·¯å¾„
    try {
      // 1. è¯»å–å½“å‰ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶ï¼ŒSyncä¸ºåŒæ­¥æ–¹æ³•
      /**
       * files æ‰“å°ç»“æœæœ‰å¥½å‡ æ¬¡ï¼Œæ¯æ¬¡ä¸ºä¸€ä¸ªfileç›®å½•ä¸‹çš„æ‰€æœ‰å±‚çº§
       * 
       * å¦‚è¾“å‡ºç›®å½•ä¸ºï¼š
       * - dist
       *   ---- images
       *          ---- hashxxx.jpg
       *   ---- js
       *          ---- main.js
       *   ---- index.html
       * 
       * æ‰“å°ç»“æœåˆ†åˆ«ä¸ºï¼š
       * ç±»ä¼¼æ ‘çš„éå†
       * [ 'images', 'index.html', 'js' ] // å¦‚æœæ²¡æœ‰ä¸‹é¢çš„é€’å½’è°ƒç”¨ï¼Œåªä¼šæ‰“å°æœ€ä¸Šé¢è¿™ä¸€è¡Œ
       * [ '2e1b040a6c7910eb.jpg' ] // é€’å½’è°ƒç”¨ä¸‹ä¸€å±‚æ‰“å°ç»“æœ
       * [ 'main.js' ] // é€’å½’è°ƒç”¨ä¸‹ä¸€å±‚æ‰“å°ç»“æœ
       * 
       * ä¹Ÿå°±æ˜¯æ¯ä¸€ä¸ªç›®å½•å±‚çº§ä¸‹æ‰€æœ‰çš„æ–‡ä»¶ï¼ˆåŒ…æ‹¬å­ç›®å½•æˆ–è€…æ–‡ä»¶ï¼‰
       */
      const files = fs.readdirSync(path);

      // 2. éå†æ–‡ä»¶ï¼Œåˆ¤æ–­æ˜¯æ–‡ä»¶å¤¹è¿˜æ˜¯æ–‡ä»¶ï¼šæ–‡ä»¶ç›´æ¥åˆ é™¤ï¼Œæ–‡ä»¶å¤¹éœ€è¦å†æ¬¡éå†åˆ é™¤å…¶ä¸‹é¢æ‰€æœ‰å†…å®¹æ‰èƒ½åˆ é™¤
      // æ€æƒ³ï¼šæ ‘çš„åˆ é™¤
      files.forEach((file) => {
        // è·å–æ–‡ä»¶å®Œæ•´è·¯å¾„ã€æ³¨æ„æ‹¼å®Œã€‘ï¼Œfileåªæœ‰æ–‡ä»¶åæ²¡æœ‰path
        const filePath = `${path}/${file}`;
        // åˆ†ææ–‡ä»¶ï¼Œé‡Œé¢æ˜¯ä¸€äº›æ–‡ä»¶ä¿¡æ¯ï¼Œæ—¥æœŸä½œè€…ç­‰ç­‰
        const fileStat = fs.statSync(filePath);
        // åˆ¤æ–­æ˜¯å¦æ˜¯æ–‡ä»¶å¤¹
        if (fileStat.isDirectory()) {
          // æ˜¯æ–‡ä»¶å¤¹éœ€è¦é€’å½’éå†åˆ é™¤ä¸‹é¢æ‰€æœ‰æ–‡ä»¶
          this.removeFiles(fs, filePath);
        } else {
          // ä¸æ˜¯æ–‡ä»¶å¤¹å°±æ˜¯æ–‡ä»¶ï¼Œç›´æ¥åˆ é™¤
          fs.unlinkSync(filePath);
        }
      });

      // æœ€ååˆ é™¤å½“å‰ç›®å½•
      fs.rmdirSync(path);
    } catch (e) {
      // å°†äº§ç”Ÿçš„é”™è¯¯è¿”å›å‡ºå»
      return e;
    }
  }
}

module.exports = CleanWebpackPlugin;
